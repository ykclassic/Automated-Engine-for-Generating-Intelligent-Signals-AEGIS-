name: AEGIS Signal Generation

on:
  workflow_run:
    workflows: ["AEGIS Indicator Pipeline"]
    types:
      - completed
    branches:
      - main
  
  schedule:
    - cron: '*/5 * * * *'
  
  workflow_dispatch:

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    # Run if indicator pipeline succeeded or triggered manually/scheduled
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install lightgbm xgboost joblib
      
      - name: Download processed signals from triggering workflow
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: processed-signals
          path: data/processed
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download processed signals from current workflow
        if: ${{ github.event_name != 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: processed-signals
          path: data/processed
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fallback to data branch if no artifact
        run: |
          # If artifact download failed, try to get from data-storage branch
          if [ ! -f "data/processed/latest_signals.json" ]; then
            echo "No artifact found, fetching from data-storage branch..."
            git fetch origin data-storage:data-storage || true
            mkdir -p data/processed
            git show data-storage:processed/latest_signals.json > data/processed/latest_signals.json 2>/dev/null || true
            
            if [ ! -f "data/processed/latest_signals.json" ]; then
              echo "‚ö†Ô∏è No signals file found, creating empty one"
              echo '[]' > data/processed/latest_signals.json
            fi
          fi
      
      - name: Generate and send signals
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python -c "
          import sys
          import os
          import json
          import requests
          from datetime import datetime
          
          sys.path.insert(0, 'src')
          
          from notifications.formatter import SignalFormatter
          
          formatter = SignalFormatter()
          webhook = os.environ.get('DISCORD_WEBHOOK')
          
          # Load signals
          try:
              with open('data/processed/latest_signals.json') as f:
                  signals = json.load(f)
          except Exception as e:
              print(f'Error loading signals: {e}')
              signals = []
          
          if not signals:
              print('No signals to send')
              # Send heartbeat to Discord
              if webhook:
                  embed = {
                      'title': 'üíì AEGIS Heartbeat',
                      'description': 'No high-quality signals found in current scan.',
                      'color': 9807270,
                      'timestamp': datetime.utcnow().isoformat()
                  }
                  try:
                      requests.post(webhook, json={'embeds': [embed]})
                  except:
                      pass
              exit(0)
          
          # Send signals to Discord
          if webhook:
              print(f'Sending {len(signals)} signals to Discord...')
              
              # Send summary embed
              summary_embed = {
                  'title': 'üõ°Ô∏è AEGIS Signal Summary',
                  'description': f'Found {len(signals)} tradeable opportunities.',
                  'color': 3447003,
                  'timestamp': datetime.utcnow().isoformat(),
                  'fields': []
              }
              
              # Count by direction
              longs = sum(1 for s in signals if s.get('timeframe_confluence', {}).get('direction', '').startswith('üü¢'))
              shorts = sum(1 for s in signals if s.get('timeframe_confluence', {}).get('direction', '').startswith('üî¥'))
              
              summary_embed['fields'] = [
                  {'name': 'üü¢ Long Signals', 'value': str(longs), 'inline': True},
                  {'name': 'üî¥ Short Signals', 'value': str(shorts), 'inline': True},
                  {'name': 'üìä Total', 'value': str(len(signals)), 'inline': True}
              ]
              
              try:
                  requests.post(webhook, json={'embeds': [summary_embed]})
              except Exception as e:
                  print(f'Failed to send summary: {e}')
              
              # Send individual high-confidence signals
              for signal in signals:
                  try:
                      conf = signal.get('timeframe_confluence', {}).get('confidence', 'low')
                      if conf in ['Very High', 'High']:
                          # Format individual signal
                          direction = signal.get('timeframe_confluence', {}).get('direction', '')
                          color = 3066993 if 'BULLISH' in direction else 15158332
                          
                          embed = {
                              'title': f\\\"{signal['symbol']} Signal\\\",\                              'color': color,
                              'timestamp': signal.get('timestamp', datetime.utcnow().isoformat()),
                              'fields': [
                                  {'name': 'Direction', 'value': direction, 'inline': True},
                                  {'name': 'Confidence', 'value': f\\\"{conf} ({signal.get('timeframe_confluence', {}).get('confidence_value', '0')})\\\", 'inline': True},
                                  {'name': 'Price', 'value': f\\\"${signal.get('price', 0):,.2f}\\\", 'inline': True}
                              ]
                          }
                          
                          # Add R:R if available
                          tf_signal = signal.get('multi_timeframe', {})
                          if tf_signal.get('risk_reward'):
                              embed['fields'].append({
                                  'name': 'R:R Ratio',
                                  'value': f\\\"{tf_signal['risk_reward']:.2f}:1\\\",
                                  'inline': True
                              })
                          
                          requests.post(webhook, json={'embeds': [embed]})
                          print(f\\\"Sent signal for {signal['symbol']}\\\")
                  except Exception as e:
                      print(f'Failed to send signal: {e}')
          
          # Save signals to file for history
          os.makedirs('signals', exist_ok=True)
          timestamp = datetime.utcnow().strftime('%Y%m%d_%H%M%S')
          with open(f'signals/signals_{timestamp}.json', 'w') as f:
              json.dump(signals, f, indent=2, default=str)
          
          print(f'Completed signal generation: {len(signals)} signals')
          "
      
      - name: Upload signal history
        uses: actions/upload-artifact@v4
        with:
          name: signal-history
          path: signals/signals_*.json
          retention-days: 7
          overwrite: true
      
      - name: Commit signals to data branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git fetch origin data-storage
          git checkout data-storage || git checkout --orphan data-storage
          
          mkdir -p signals
          cp signals/signals_*.json signals/ 2>/dev/null || true
          
          git add signals/
          git commit -m "Update signals - $(date -u)" || echo "No changes"
          git push origin data-storage || echo "Nothing to push"
      
      - name: Report failure to Discord
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"‚ùå Signal Pipeline Failed\",
                \"color\": 15158332,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                \"fields\": [
                  {\"name\": \"Error\", \"value\": \"Check GitHub Actions logs\", \"inline\": false}
                ]
              }]
            }" \
            $DISCORD_WEBHOOK || true
